#!/bin/sh
# simple regression tester for toplev
# this just tests if all events resolve etc, as it would 
# need the individual CPUs.

set -e
set -x

. ./cpumap.sh

cat >hello.c <<EOL
#include <stdio.h>
int main() {
	printf("Hello world\n");
	return 0; 
}
EOL

LOAD="gcc -o /dev/null hello.c"

EVENTMAP=${cpus[ivb]} FORCECPU=ivb ./toplev.py $LOAD
EVENTMAP=${cpus[ivb]} FORCECPU=ivb ./toplev.py -d -l4 $LOAD
EVENTMAP=${cpus[ivb]} FORCECPU=ivb ./toplev.py -v -d -l4 $LOAD
EVENTMAP=${cpus[ivb]} FORCECPU=ivb ./toplev.py -x, -v -d -l4 $LOAD
EVENTMAP=${cpus[ivt]} FORCECPU=ivt ./toplev.py -d -l4 $LOAD
EVENTMAP=${cpus[snb]} FORCECPU=snb ./toplev.py -d -l4 $LOAD
EVENTMAP=${cpus[jkt]} FORCECPU=jkt ./toplev.py -d -l4 $LOAD
EVENTMAP=${cpus[hsw]} FORCECPU=hsw ./toplev.py -d -l4 $LOAD
EVENTMAP=${cpus[ivb]} FORCECPU=ivb ./toplev.py -d -l4 -I 1000 sleep 3
EVENTMAP=${cpus[ivb]} FORCECPU=ivb ./toplev.py -d -l4 --user $LOAD | tee log
grep :u log

# need new perf
# test other perf output formats
EVENTMAP=${cpus[hsw]} FORCECPU=hsw ./toplev.py -d -l4 -I 1000 -a --per-core sleep 1
EVENTMAP=${cpus[hsw]} FORCECPU=hsw ./toplev.py -d -l4 -I 1000 -a --per-socket sleep 1
EVENTMAP=${cpus[hsw]} FORCECPU=hsw ./toplev.py -d -l4 -I 1000 -a -A sleep 1

echo 
echo "SUCCEEDED"
